<html>

<head>
  <title>SignalR Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">

  <style>
    .slide-fade-enter-active, .slide-fade-leave-active {
      transition: all .5s ease;
    }

    .slide-fade-enter, .slide-fade-leave-to {
      height: 0;
      overflow-y: hidden;
      opacity: 0;
    }
  </style>
</head>

<body>
  <p>&nbsp;</p>
  <div id="app" class="container">
    <h3>Customer Service Contact Options</h3>
    <div class="row">
      <nav class="col-sm" id="navigation">
        <a href="/">Home</a> | <a href="customerservice.html">Contact Us</a>
      </nav>
    </div>
    <div class="row">
      <div class="col-sm" id="currentDateTime"></div>
    </div>
    <div class="row" v-if="!ready">
      <div class="col-sm">
        <div>Loading...</div>
      </div>
    </div>
    <div v-if="ready">
      <transition-group name="slide-fade" tag="div">
        <div class="row" v-for="order in orders" v-bind:key="order.id">
          <div class="col-sm">
            <hr />
            <div>
              <div style="display: inline-block; padding-left: 12px;">
                <div>
                  <p>
                    <span class="text-info small"><strong>{{ order.Results[0].sourceOperation }}</strong></span>
                    <span class="text-info small" v-if="!order.Results[0].open">Sorry, this service is closed.</span>
                    <span class="text-info small" v-if="order.Results[0].open">Yes, this service is open!</span>
                    <br />
                    <span class="text-info small" v-if="order.Results[0].open && order.Results[0].url != null"><a href="{{ order.Results[0].url }}">Chat with a Representative</a> </span>
                    <div class="text-info small" v-if="!order.Results[0].open">Hours of operation (GMT):</div>
                    <span class="col-sm-12" v-if="!order.Results[0].open" v-for="hours in order.Results[0].hours.OpenHours" v-bind:key="order.id">
                      <span class="text-info small">{{ hours.OpenTime }} to {{ hours.CloseTime }}</span>
                    </span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </transition-group>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.2/dist/browser/signalr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
          crossorigin="anonymous"></script>

  <script>
    const data = {
      orders: [],
      ready: false
    };

    const app = new Vue({
      el: '#app',
      data: data,
      methods: {
      }
    });

    const connection = new signalR.HubConnectionBuilder()
      .withUrl('http://localhost:7071/api')
      .configureLogging(signalR.LogLevel.Information)
      .build();

    connection.on('customerServiceNeed', customerServiceNeed);
    connection.onclose(() => console.log('disconnected'));

    console.log('connecting...');
    connection.start()
      .then(() => data.ready = true)
      .catch(console.error);

    let counter = 0;

    function customerServiceNeed(fulfilledNeed) {
      const fulfilledNeedObject = JSON.parse(fulfilledNeed);

      fulfilledNeedObject.id = counter++; // vue transitions need an id
      data.orders.unshift(fulfilledNeedObject);
    }

    $(document).ready(function () {
      $.ajax("http://localhost:7071/api/customer/222/customerservice/contact");

      $("#currentDateTime").text((new Date()).toUTCString());

    });
  </script>
</body>

</html>